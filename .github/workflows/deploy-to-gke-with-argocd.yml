# EXAMPLE - https://hbayraktar.medium.com/news-summary-app-automated-ci-cd-with-github-actions-argocd-gke-c90e5575235b
# EXAMPLE GITHUB REPO - https://github.com/hakanbayraktar/news-summary-gke

# Make sure argocd is installed on the same cluster, installation guide is in gke-files-argocd/ArgoCD-Installation.md

# This workflow:
# 1. Triggers on push to main branch
# 2. Builds and pushes Docker image
# 3. Updates image tag in manifests
# 4. Syncs entire gke-files-argocd folder to argocd branch (creates if doesn't exist)
# 5. ArgoCD watches argocd branch and auto-deploys

name: Build & Deploy to GKE with ArgoCD
on:
  push:
    branches:
      - mainn

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: autopilot-cluster-1 # Add your cluster name here.
  GKE_LOCATION: us-central1 # Add your cluster zone here.
  IMAGE_TAG: ${{ github.sha }}
  GCP_ARTIFACT_REGISTRY: us-central1-docker.pkg.dev # can be found in the artifact repository
  SERVICE_ACCOUNT_USERNAME: _json_key # this stays same as we are using a service account key
  GCP_ARTIFACT_REPOSITORY: gke-repo # artifact repository name
  DEPLOYMENT_NAME: frontend-deployment-argocd # Add your deployment name here.
  NAMESPACE: playground-argocd # Add your namespace here

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: "write" # write permission needed to push to argocd branch
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # fetch all history and branches

      - name: Setup GCloud
        uses: "google-github-actions/auth@v3"
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Login to GCP Artifact Registry
        uses: docker/login-action@v3
        id: login-registry
        with:
          registry: ${{ env.GCP_ARTIFACT_REGISTRY }}
          username: ${{ env.SERVICE_ACCOUNT_USERNAME }}
          password: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Get GKE Cluster Credentials
        id: "get-credentials"
        uses: "google-github-actions/get-gke-credentials@v3"
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }} # required unless cluster name is a full resource name - projects/<project>/locations/<location>/clusters/<cluster>

      - name: Build, Tag and Push Image to GCP Artifact Repository
        id: build-image
        run: |
          docker build -t ${{ env.GCP_ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPOSITORY }}/app:${{ env.IMAGE_TAG }} -t ${{ env.GCP_ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPOSITORY }}/app:latest -f Dockerfile .
          docker push ${{ env.GCP_ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPOSITORY }}/app:${{ env.IMAGE_TAG }}
          docker push ${{ env.GCP_ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPOSITORY }}/app:latest
          echo "appimage=${{ env.GCP_ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPOSITORY }}/app:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT

      - name: Sync Manifests to ArgoCD Branch
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all branches
          git fetch origin

          # Switch to argocd branch (create if doesn't exist)
          git checkout argocd 2>/dev/null || git checkout -b argocd
          git pull origin argocd 2>/dev/null || true

          # Remove old gke-files-argocd in argocd branch (git operation, not filesystem)
          git rm -rf gke-files-argocd 2>/dev/null || true

          # Copy fresh gke-files-argocd from main branch
          git checkout main -- gke-files-argocd

          # Now update image in deployment.yml (in argocd branch)
          sed -i "s|image:.*|image: ${{ steps.build-image.outputs.appimage }}|g" gke-files-argocd/frontend/deployment.yml

          # Stage all changes (additions, modifications, deletions)
          git add -A gke-files-argocd

          # Commit and push to argocd branch
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "ðŸš€ Manifests: Update image to ${{ env.IMAGE_TAG }}"
            git push origin argocd
            echo "âœ… Manifests synced to argocd branch - ArgoCD will auto-deploy"
          fi
